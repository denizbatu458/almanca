<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mesajlaşma | Deutsch Lernen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --bg1:#161d3f; --bg2:#101633; --card:rgba(255,255,255,.08); --text:#f5f7ff; --muted:#c7d0ff; --border:rgba(255,255,255,.16); --neon:#ff4b4b; --neon2:#ff8a8a; --ok:#4be38a; }
body{ margin:0; font-family:Inter,sans-serif; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); min-height:100vh; overflow: hidden; }
.container{ max-width:600px; margin:0 auto; padding:20px; height: 100vh; display: flex; flex-direction: column; }
header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-shrink: 0; }
.chat-box{ background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:20px; flex: 1; overflow-y:auto; padding:20px; margin-bottom:20px; display:flex; flex-direction:column; gap:10px; scroll-behavior: smooth; }
/* Mesaj Balonları */
.bubble{ max-width:85%; padding:12px 16px; border-radius:18px; font-size:14px; position:relative; line-height:1.4; word-wrap: break-word; animation: fadeIn 0.2s; }
.bubble.me{ align-self: flex-end; background: var(--neon); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 12px rgba(255, 75, 75, 0.2); }
.bubble.teacher{ align-self: flex-start; background: var(--card); border:1px solid var(--border); border-bottom-left-radius: 4px; }
.bubble small{ display:block; font-size:10px; margin-top:5px; opacity:0.7; text-align: right; }
/* Input Alanı */
.input-area{ background:var(--card); padding:15px; border-radius:20px; border:1px solid var(--border); display:flex; gap:10px; align-items: center; flex-shrink: 0; margin-bottom: 10px;}
textarea{ flex:1; background:transparent; border:none; color:white; outline:none; resize:none; height:45px; font-family:inherit; font-size: 14px; padding-top: 10px; }
button{ background:linear-gradient(135deg,var(--neon),var(--neon2)); border:none; padding:12px 24px; border-radius:12px; color:white; font-weight:800; cursor:pointer; transition: 0.3s; }
button:hover{ transform: scale(1.05); filter: brightness(1.1); }
.back-btn{ text-decoration:none; color:var(--muted); font-size:14px; font-weight: 600; }
.back-btn:hover{ color: #fff; }

@keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
.chat-box::-webkit-scrollbar { width: 6px; }
.chat-box::-webkit-scrollbar-track { background: transparent; }
.chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
</style>
</head>
<body>

<div class="container">
  <header>
    <a href="index.html" class="back-btn">← Panele Dön</a>
    <h2 style="margin:0">Mesajlar</h2>
  </header>

  <div class="chat-box" id="chatBox"></div>

  <div class="input-area">
    <textarea id="msgInput" placeholder="Hocaya bir mesaj yazın..."></textarea>
    <button onclick="send()">Gönder</button>
  </div>
</div>

<script>
const KEY_MSG = "student_messages"; 
const KEY_REPLIES = "teacher_replies"; 
const KEY_SESSION = "session_student_id";

function loadChat() {
  const sess = localStorage.getItem(KEY_SESSION);
  if(!sess) {
      window.location.href = "index.html";
      return;
  }

  const chatBox = document.getElementById("chatBox");
  const allMsgs = JSON.parse(localStorage.getItem(KEY_MSG)) || [];
  const allReplies = JSON.parse(localStorage.getItem(KEY_REPLIES)) || [];

  const myMsgs = allMsgs
    .filter(m => String(m.studentId) === String(sess))
    .map(m => ({...m, type: 'me'}));
  
  const myReplies = allReplies
    .filter(r => String(r.studentId) === String(sess))
    .map(r => ({...r, type: 'teacher'}));

  // Tarihe göre sırala: Eskiden Yeniye (En yeni altta)
  const fullChat = [...myMsgs, ...myReplies].sort((a, b) => new Date(a.date) - new Date(b.date));

  let html = "";
  if(fullChat.length === 0) {
      html = '<div style="text-align:center; color:var(--muted); margin-top:20px; font-size:13px;">Henüz mesaj yok. İlk mesajı sen gönder!</div>';
  } else {
      fullChat.forEach(chat => {
          const time = new Date(chat.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          html += `<div class="bubble ${chat.type}">${chat.text} <small>${time}</small></div>`;
      });
  }

  chatBox.innerHTML = html;
  
  // En alta odaklan
  chatBox.scrollTop = chatBox.scrollHeight;

  // Okundu işaretle
  const updatedReplies = allReplies.map(r => {
    if(String(r.studentId) === String(sess)) return {...r, read: true};
    return r;
  });
  localStorage.setItem(KEY_REPLIES, JSON.stringify(updatedReplies));
}

function send() {
  const sess = localStorage.getItem(KEY_SESSION);
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  
  if(!sess || !text) return;

  const msgs = JSON.parse(localStorage.getItem(KEY_MSG)) || [];
  msgs.push({
    studentId: sess,
    text: text,
    date: new Date().toISOString()
  });

  localStorage.setItem(KEY_MSG, JSON.stringify(msgs));
  input.value = "";
  loadChat();
}

document.getElementById("msgInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

loadChat();
setInterval(loadChat, 4000);
</script>
</body>
</html>